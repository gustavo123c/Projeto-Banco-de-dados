import mysql.connector

def conectar():
    return mysql.connector.connect(
        host="localhost",
        user="admin", 
        password="admin123",
        database="ecommerce"
    )

def registrar_venda():
    con = conectar()
    cursor = con.cursor()
    print("\n=== Registrar Nova Venda ===")
    try:
        id_cliente = int(input("ID do cliente: "))
        id_produto = int(input("ID do produto: "))
        id_vendedor = int(input("ID do vendedor: "))
        id_transportadora = int(input("ID da transportadora: "))
        destino = input("Cidade de destino: ")
        valor = float(input("Valor do produto: "))

        cursor.callproc('Venda', (id_cliente, id_produto, id_vendedor, id_transportadora, destino, valor))
        con.commit()
        print("Venda registrada com sucesso!")
    except Exception as e:
        print(f"Erro ao registrar venda: {e}")
        con.rollback()
    finally:
        cursor.close()
        con.close()

def listar_vendas():
    con = conectar()
    cursor = con.cursor()
    try:
        cursor.execute("SELECT * FROM vw_vendas_detalhadas")
        vendas = cursor.fetchall()
        
        print("\n=== Vendas Detalhadas ===")
        print(f"Total de vendas encontradas: {len(vendas)}")
        
        if len(vendas) == 0:
            print("Nenhuma venda encontrada.")
            return
        
        # Pergunta se quer ver todas ou paginado
        opcao = input("Mostrar todas de uma vez? (s/n): ").lower()
        
        if opcao == 's':
            for i, linha in enumerate(vendas, 1):
                print(f"{i}. {linha}")
        else:
            # Mostra paginado
            pagina = 0
            itens_por_pagina = 10
            
            while True:
                inicio = pagina * itens_por_pagina
                fim = inicio + itens_por_pagina
                pagina_vendas = vendas[inicio:fim]
                
                print(f"\n--- P치gina {pagina + 1} ---")
                for i, linha in enumerate(pagina_vendas, inicio + 1):
                    print(f"{i}. {linha}")
                
                if fim >= len(vendas):
                    print("\n--- Fim da lista ---")
                    break
                
                proxima = input("\nEnter para pr칩xima p치gina, 'q' para sair: ")
                if proxima.lower() == 'q':
                    break
                
                pagina += 1
                
    except Exception as e:
        print(f"Erro ao listar vendas: {e}")
    finally:
        cursor.close()
        con.close()

def calcular_idade():
    con = conectar()
    cursor = con.cursor()
    try:
        id_cliente = int(input("ID do cliente: "))
        cursor.execute(f"SELECT Calcula_Idade({id_cliente})")
        idade = cursor.fetchone()[0]
        print(f"Idade do cliente: {idade} anos")
    except Exception as e:
        print(f"Erro ao calcular idade: {e}")
    finally:
        cursor.close()
        con.close()

def estatisticas():
    con = conectar()
    cursor = con.cursor()
    try:
        print("\n=== Estat칤sticas ===")
        cursor.callproc('Estatisticas')
        for result in cursor.stored_results():
            for row in result.fetchall():
                print(row)
    except Exception as e:
        print(f"Erro ao buscar estat칤sticas: {e}")
    finally:
        cursor.close()
        con.close()

def realizar_sorteio():
    con = conectar()
    cursor = con.cursor()
    try:
        print("\n=== Realizar Sorteio ===")
        cursor.callproc('Sorteio')
        for result in cursor.stored_results():
            for row in result.fetchall():
                print(row[0])
    except Exception as e:
        print(f"Erro ao realizar sorteio: {e}")
    finally:
        cursor.close()
        con.close()

def calcular_soma_fretes():
    con = conectar()
    cursor = con.cursor()
    try:
        print("\n=== Soma dos Fretes por Cidade ===")
        destino = input("Digite a cidade para somar os fretes: ")
        cursor.execute(f"SELECT Soma_Fretes('{destino}')")
        total = cursor.fetchone()[0]
        print(f"Total de fretes para {destino}: R$ {total:.2f}")
    except Exception as e:
        print(f"Erro ao calcular soma de fretes: {e}")
    finally:
        cursor.close()
        con.close()

def calcular_arrecadado():
    con = conectar()
    cursor = con.cursor()
    try:
        print("\n=== Total Arrecadado por Vendedor ===")
        id_vendedor = int(input("ID do vendedor: "))
        
        # Soma todas as vendas do vendedor, independente da data
        cursor.execute("""
            SELECT COALESCE(SUM(valor_total), 0) 
            FROM vendas 
            WHERE id_vendedor = %s
        """, (id_vendedor,))
        
        total = cursor.fetchone()[0]
        
        # Busca o nome do vendedor para mostrar
        cursor.execute("SELECT nome FROM vendedores WHERE id = %s", (id_vendedor,))
        vendedor = cursor.fetchone()
        nome_vendedor = vendedor[0] if vendedor else "N칚o encontrado"
        
        print(f"\n游늵 TOTAL ARRECADADO:")
        print(f"Vendedor: {nome_vendedor} (ID: {id_vendedor})")
        print(f"Total geral: R$ {total:.2f}")
        
    except ValueError:
        print("Erro: ID do vendedor deve ser um n칰mero inteiro.")
    except Exception as e:
        print(f"Erro ao calcular valor arrecadado: {e}")
    finally:
        cursor.close()
        con.close()

def reajuste_salario():
    con = conectar()
    cursor = con.cursor()
    try:
        print("\n=== Reajuste Salarial ===")
        percentual = float(input("Percentual de reajuste: "))
        cargo = input("Cargo para reajuste: ")
        cursor.callproc('Reajuste', (percentual, cargo))
        con.commit()
        print(f"Reajuste de {percentual}% aplicado para {cargo}s!")
    except Exception as e:
        print(f"Erro ao aplicar reajuste: {e}")
        con.rollback()
    finally:
        cursor.close()
        con.close()

def listar_vendedores_bonus():
    con = conectar()
    cursor = con.cursor()
    try:
        cursor.execute("SELECT * FROM vw_vendedores_bonus")
        print("\n=== Vendedores com Bonus ===")
        for linha in cursor.fetchall():
            print(linha)
    except Exception as e:
        print(f"Erro ao listar vendedores: {e}")
    finally:
        cursor.close()
        con.close()

def listar_vendas_mensais():
    con = conectar()
    cursor = con.cursor()
    try:
        cursor.execute("SELECT * FROM vw_vendas_mensais")
        print("\n=== Vendas Mensais ===")
        for linha in cursor.fetchall():
            print(linha)
    except Exception as e:
        print(f"Erro ao listar vendas mensais: {e}")
    finally:
        cursor.close()
        con.close()

def listar_clientes_especiais():
    con = conectar()
    cursor = con.cursor()
    try:
        cursor.execute("""
            SELECT c.id, c.nome, ce.cashback 
            FROM clientes c 
            JOIN clientes_especiais ce ON c.id = ce.id_cliente
        """)
        print("\n=== Clientes Especiais ===")
        for linha in cursor.fetchall():
            print(linha)
    except Exception as e:
        print(f"Erro ao listar clientes especiais: {e}")
    finally:
        cursor.close()
        con.close()

def listar_funcionarios_especiais():
    con = conectar()
    cursor = con.cursor()
    try:
        cursor.execute("""
            SELECT v.id, v.nome, fe.bonus 
            FROM vendedores v 
            JOIN funcionarios_especiais fe ON v.id = fe.id_vendedor
        """)
        print("\n=== Funcion치rios Especiais ===")
        for linha in cursor.fetchall():
            print(linha)
    except Exception as e:
        print(f"Erro ao listar funcion치rios especiais: {e}")
    finally:
        cursor.close()
        con.close()

def menu():
    while True:
        print("\n" + "="*40)
        print("           SISTEMA E-COMMERCE")
        print("="*40)
        print("1. Registrar venda")
        print("2. Listar vendas detalhadas")
        print("3. Calcular idade de cliente")
        print("4. Estat칤sticas completas")
        print("5. Realizar sorteio")
        print("6. Calcular soma dos fretes por cidade")
        print("7. Calcular valor arrecadado")
        print("8. Aplicar reajuste salarial")
        print("9. Listar vendedores com bonus")
        print("10. Listar vendas mensais")
        print("11. Listar clientes especiais")
        print("12. Listar funcion치rios especiais")
        print("0. Sair")
        print("-"*40)

        opcao = input("Escolha uma op칞칚o: ")

        if opcao == '1':
            registrar_venda()
        elif opcao == '2':
            listar_vendas()
        elif opcao == '3':
            calcular_idade()
        elif opcao == '4':
            estatisticas()
        elif opcao == '5':
            realizar_sorteio()
        elif opcao == '6':
            calcular_soma_fretes()
        elif opcao == '7':
            calcular_arrecadado()
        elif opcao == '8':
            reajuste_salario()
        elif opcao == '9':
            listar_vendedores_bonus()
        elif opcao == '10':
            listar_vendas_mensais()
        elif opcao == '11':
            listar_clientes_especiais()
        elif opcao == '12':
            listar_funcionarios_especiais()
        elif opcao == '0':
            print("Encerrando sistema...")
            break
        else:
            print("Op칞칚o inv치lida!")

if __name__ == "__main__":  
    menu()
